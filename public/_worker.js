export default {
	async fetch(request, env) {
		const url = new URL(request.url);
		const check = request.headers['referer'] || 'yousayaido.com';
		if (request.headers['postman-token'] || check.indexOf('yousayaido.com') === -1) {
			return new Response('Bad Request', { status: 400 });
		}
		else if (url.pathname.startsWith('/shared/')) {
			//console.log('Shared Request:', url.pathname, env.KV, env.HOSTING);
			return await hosting({ headers: request.headers, method: request.method, url: url.pathname.slice(8) }, env.HOSTING);
		} else if (url.pathname.startsWith('/api')) {
			if (request.method !== 'POST') return new Response('Bad Request', { status: 400 });
			//console.log('API Request:', url.pathname, env.KV, env.HOSTING);
			return await connector(request, env.KV, env.HOSTING);
		} else if (url.pathname === '/images/yousayaido.png' || url.pathname === '/favicon.ico') {
			return new Response(env.ASSETS.get('images/yousayaido.png'), { headers: { 'Content-Type': 'image/png' } });
		} else if (url.pathname === '/') {
			if (request.method !== 'GET') return new Response('Bad Request', { status: 400 });
			return env.ASSETS.fetch(request);
		}
		return new Response('Bad Request', { status: 400 });
	},
};
async function connector(a,o,i){const r=await o.get("OPENAI_API_URL"),c=await o.get("CLAUDE_API_URL"),u=await o.get("CLAUDE_MODEL"),d=await o.get("OPENAI_MODEL"),h=await o.get("OPENAI_ORGANIZATION_ID"),m={Authorization:`Bearer ${await o.get("OPENAI_API_KEY")}`,"Content-Type":"application/json"};h&&(m["OpenAI-Organization"]=h);const f={"x-api-key":await o.get("CLAUDE_API_KEY"),"anthropic-version":"2023-06-01","anthropic-beta":"max-tokens-3-5-sonnet-2024-07-15","Content-Type":"application/json"};try{const o=await a.json();if(o.project){const e=(new Date).getTime().toString();return await i.put(e,o.project.html),new Response(null,{headers:{etag:e}})}if(o.conversation){const e="string"==typeof o.conversation?[{role:"user",content:o.conversation}]:o.conversation,n=await t(c,f,u,e,1e3,!0,p);return new Response(n,{headers:{"Content-Type":"plain/text"}})}if(o.prompt||o.messages||o.images){const{prompt:a="",messages:i=[],images:p=[]}=o,h=[];for(var g of i)"string"==typeof g?h.push({role:"user",content:g}):g.role&&g.content&&h.push({role:g.role,content:g.content});if(a&&h.push({role:"user",content:a}),p.length>0){e(h,p);const t=await n(r,m,d,h,500,!0,l);return new Response(JSON.stringify(t),{headers:{"Content-Type":"application/json"}})}console.log(h);const y=s(await t(c,f,u,h,8192,!1));return new Response(JSON.stringify(y),{headers:{"Content-Type":"application/json"}})}if(o.title&&o.input&&o.files){const e=[];for(const t of o.files){const{filename:n,extension:a,content:o}=t,i="html"===a||"svg"===a?`\x3c!-- ${n} --\x3e`:"css"===a?`/* ${n} */`:`// ${n}`;e.push(`\`\`\`${"js"===a?"javascript":a}\n${i}\n${o}\n\`\`\``)}const n=e.join("\n\n"),a=o.context||[],i=await t(c,f,u,n.trim()?[{role:"user",content:o.title},{role:"assistant",content:n},...a.map((e=>({role:"user",content:e}))),{role:"user",content:o.input}]:[{role:"user",content:o.title},...a.map((e=>({role:"user",content:e}))),{role:"user",content:o.input}],8192,!1),r=s(i);return new Response(JSON.stringify(r),{headers:{"Content-Type":"application/json"}})}return new Response("Bad Request",{status:400})}catch(e){return console.log(e),new Response("Internal Server Error",{status:500})}}async function hosting(e,t){const n=e.url;if(console.log(`${e.method} object ${n}`),"GET"===e.method){const a=await t.get(n,{range:e.headers,onlyIf:e.headers});if(!a)return new Response("Not Found",{status:404});const o=new Headers;a.writeHttpMetadata(o),o.set("etag",a.httpEtag),a.range&&o.set("content-range",`bytes ${a.range.offset}-${a.range.end??a.size-1}/${a.size}`);const i=a.body?e.headers.get&&null!==e.headers.get("range")?206:200:304;return new Response(a.body,{headers:o,status:i})}if("HEAD"===e.method){const e=await t.head(n);if(!e)return new Response("Not Found",{status:404});const a=new Headers;return e.writeHttpMetadata(a),a.set("etag",e.httpEtag),new Response(null,{headers:a})}}function e(e,t){let n;for(const t of e)"user"===t.role&&(n=t);n||(n={role:"user",content:l},e.push(n));const a=n.content;n.content=[],a&&n.content.push({type:"text",text:a});for(const e of t)n.content.push({type:"image_url",image_url:{url:e}})}async function t(e,n,i,s,r,c){try{const l=await fetch(`${e}/messages`,{headers:n,method:"POST",body:JSON.stringify({model:i,max_tokens:r,messages:a(s),system:u})}),p=await l.json();if(p&&p.error)return console.log(p.error),"ðŸš¨ An error occurred while generating content. Please try again.";if(p&&"overloaded_error"===p.type)return console.log(p.error),"ðŸš¨ Claude API is overloaded. Please try again later.";if(p&&"max_tokens"===p.stop_reason&&c){const a=o(p);s.push({role:"assistant",content:a}),s.push({role:"user",content:"Continue exactly where you left off"}),c=(r=Math.min(8192,2*r))<8192;const l=await t(e,n,i,s,r,c);return 0===l.indexOf(a)?l:a+l}return o(p)}catch(e){return console.log(e),"ðŸš¨ An error occurred while generating content. Please try again."}}async function n(e,t,a,o,i=150,s=!0,r){try{const c=await fetch(`${e}/chat/completions`,{headers:t,method:"POST",body:JSON.stringify({model:a,max_tokens:i,messages:[{role:"system",content:r||u},...o]})}),l=await c.json();if(l&&l.choices&&l.choices[0]&&l.choices[0].message&&l.choices[0].message.content){const c=l.choices[0].message.content.trim();if("length"===l.choices[0].finish_reason&&s){o.push({role:"assistant",content:c}),o.push({role:"user",content:"Continue exactly where you left off"}),s=(i=Math.min(4095,2*i))<4095;const l=await n(e,t,a,o,i,s,r);return 0===l.indexOf(c)?l:c+l}return c}return""}catch(e){return console.log(e),"ðŸš¨ An error occurred while generating content. Please try again."}}function a(e){const t=[];let n=null,a="";for(const o of e)if(o.role!==n)n&&t.push({role:n,content:a.trim()}),n=o.role,Array.isArray(o.content)||(a=o.content);else if(Array.isArray(o.content))for(const e of o.content)"image_url"===e.type&&(e.type="image",e.source={type:"base64",media_type:"image/png",data:e.image_url.url});else a+="\n"+o.content;n&&""!==a.trim()&&t.push({role:n,content:a.trim()});const o=[];let i=!1;for(const e of t)"user"===e.role&&(i=!0),i&&o.push(e);return o}function o(e){if(e.error)throw new Error(JSON.stringify(e.error));const t=e.content;return"string"==typeof t?t.trim():Array.isArray(t)?t.map((e=>e.text?.trim()||"")).join("\n"):""}function i(e,t){const n=/```(.*?)\n([\s\S]*?)```/g;let a;for(;null!==(a=n.exec(e));)if(a){const e=a[1].trim();t({text:a[2].trim(),type:e})}}function s(e){const t=[],n=/```(\w+)?\n([\s\S]*?)```/g;let a;for(;null!==(a=n.exec(e));){const e=a[1]?a[1].trim():"";let n=a[2];if(["html","css","js","javascript","svg"].includes(e.toLowerCase())){const{fileName:a,cleanedContent:o}=r(n,e);if(!a)continue;n=o;const i=a.split(".").pop();t.push({filename:a,extension:i,language:e,content:n.trim(),mimeType:"html"===e?"text/html":"css"===e?"text/css":"svg"===e?"image/svg+xml":"json"===e?"application/json":"text/javascript"})}}const o=/((?:\|.*?\|\n)+)/g;let i;for(;null!==(i=o.exec(e));){const e=c(i[1]);if(0===e.length)continue;const n=`table${t.length+1}.json`;t.push({filename:n,extension:"json",language:"json",content:JSON.stringify(e,null,2)})}return t}function r(e,t){const n=e.split("\n");let a=n[0].trim(),o="",i="",s="";if(["js","javascript"].includes(t.toLowerCase())?i="//":["html","svg"].includes(t.toLowerCase())?(i="\x3c!--",s="--\x3e"):"css"===t.toLowerCase()&&(i="/*",s="*/"),a.startsWith(i)){if(s){const e=a.indexOf(s);-1!==e&&(o=a.substring(i.length,e).trim())}else o=a.substring(i.length).trim();n.shift(),e=n.join("\n")}return{fileName:o,cleanedContent:e}}function c(e){const t=e.trim().split("\n");if(t.length<2)return[];const n=t[0],a=(t[1],t.slice(2)),o=n.split("|").map((e=>e.trim())).filter((e=>e));return a.map((e=>{const t=e.split("|").map((e=>e.trim())).filter((e=>e)),n={};return o.forEach(((e,a)=>{n[e]=t[a]||""})),n}))}var l="Describe this image for an LLM that will use this information to create a web page, app or game using HTML, SVG, WebGL+Shaders, CSS, and vanilla JavaScript.",p="You are an AI assistant specializing in the topic in which the user will provide instructions. Your task is to generate a response based on the user's input, providing detailed information, explanations, or creative content as needed. When presented with a conversation prompt, interpret it as a window into a collaborative exploration in the name of productivity, fun, and imaginative creations. Based on the context given by the user, extrapolate the contents and purpose of the conversation, and how it might fit into a broader internet of possibility.",u='You are an AI assistant participating in a collaborative exploration in the name of productivity, fun, and imaginative creations. Your task is to generate immersive, creative HTML content based on instructions provided by the user, imagining a version of the internet where any conceivable web page, app, or game can exist and run locally in the browser.\n\nWhen presented with instructions for a web page, app or game, interpret it as a window into an alternate internet where that information space exists, no matter how fanciful or improbable it may seem. Based on the context given by the user, extrapolate the contents and purpose of the site, and how it might fit into a broader internet of possibility.\n\nGenerate all files necessary, each in a code fence, for the HTML markup, styles and components for the imagined website, including relevant tags, concise CSS, and interactive elements. Ensure your content immerses the user in this crafted internet through descriptive text, CSS drawings and animations, and contextually-relevant components and intuitive behavior. Prefer to generate productive experiences which enable the user to automate a task or collect information in a streamlined way. Each app or game must be fully functional with no errors or bugs and run locally inside a browser.\n\nFollow these guidelines when generating HTML:\n1. Use expressive CSS+animations (or WebGL+Shaders) to draw and animate visual elements.\n2. Don\'t include image tags or external resources.\n3. Utilize a responsive design that adapts to different screen sizes and device types, with controls or interactions that are intuitive and accessible.\n4 Use local storage and other means of caching data for the user.\n5. If including input fields, place them within a form element with method="dialog" and an appropriate action attribute or onsubmit event.\n6. When using script tags, ensure that the JavaScript code is fully complete and uses functions to delineate the required functionality.\n7. **Bonus API Available**: If an AI capability is required, use the relative `/api` endpoint with a POST request to send JSON containing a `conversation` property which is either a string or a list of messages, and receive the AI-generated response as plain text.\n7. If an external API is necessary, with open data or at least CORS is preferred, provide a configuration pane for the user to save their preferred settings and ensure that the API integration handles errors and loading states gracefully.\n8. Use any of the following for the theme of all apps generated, adding the necessary enhancements with CSS. Choices: Spectre.css, MatchaCSS, 98.CSS, XP.css, PaperCSS, MetroCSS, Water.css, Mini.css, Miligram, Shoelace.css, Skeleton, Simple.css, MVP.css\n9. Do not show sample data or ficticious data in the app, and ensure that the app is fully functional with the real data - either from the user or an open or configurable API.\n\nThe user may include out-of-character (OOC) comments or questions - acknowledge these indirectly in the HTML you generate, integrating them into the fabric of the internet you are crafting.\n\nWhen imagining the contents of each information space, consider:\n- Unique technologies, design trends, or social dynamics that might enable this to exist\n- Deeper themes, ideas, or meanings that could be subtly woven into the content and purpose\n- How history might look different if this were to exist\n- How this site might expand the possibilities of what the internet can be used for\n- How the user might interact with the site, and what they might learn or experience\n- How the site might be discovered by other users, and what they might think of it\n\nEmbrace a tone of open-ended creativity, thoughtful exploration, playfulness, and light-hearted fun. You are an imaginative architect, progressively building out a counterfactual internet one page, app or game at a time in collaboration with the user.\n\n**Objective:** Develop the specified web components strictly using HTML5, CSS3, Vanilla JavaScript, WebGL, SVG, and Shader Language. Ensure each component is autonomous, standards-compliant, and ready for seamless integration into the main application without external frameworks.\n\n**Instructions:**\n\n1. **Output Format:**\n   - **Code Blocks:** Use Markdown code fences for each file.\n   - **Filename Comments:** At the top of each code block, include a comment specifying the filename and its purpose.\n   - **Example:**\n```javascript\n// ./calculator.js\nexport function calculate() {\n    // Calculation logic\n}\n```\n   \n2. **HTML5 Component Development:**\n   - **Description:** Construct a self-contained HTML5 template.\n   - **Standards:** Use semantic elements, unique IDs, and classes as specified.\n   - **Example:**\n```html\n\x3c!-- ./index.html --\x3e\n<div id="calculator-display" class="component-display"></div>\n```\n\n3. **CSS3 Styling:**\n   - **Description:** Create an isolated CSS3 module for the HTML component.\n   - **Standards:** Follow the provided naming conventions and ensure no style conflicts.\n   - **Example:**\n```css\n/* ./display.css */\n.component-display {\n    font-size: 2em;\n    color: #333;\n}\n```\n\n4. **Vanilla JavaScript Functionality:**\n   - **Description:** Develop a standalone JavaScript module to handle specific functionality.\n   - **Standards:** Implement the standardized interface for interoperability.\n   - **Example:**\n```javascript\n// ./display.js\nexport function updateDisplay(value) {\n    document.getElementById(\'calculator-display\').innerText = value;\n}\n```\n\n5. **WebGL/SVG Integration:**\n   - **Description:** Implement graphics or visual effects as specified.\n   - **Standards:** Ensure optimization and compatibility with HTML5.\n   - **Example:**\n```javascript\n// ./effects.js\n// WebGL or SVG related code\n```\n\n6. **Documentation:**\n   - **Description:** Document the development process, including code comments and integration instructions.\n   - **Standards:** Provide clear and concise documentation for future maintenance.\n   - **Example:**\n```markdown\n\x3c!-- display.md --\x3e\n# Display Component Documentation\n    - **Purpose:** Updates the calculator display.\n    - **Usage:** Import `updateDisplay` from `display.js` and call it with the desired value.\n```\n\n**Continuous File Generation:**\n- Continue generating additional files as per the project plan.\n- Ensure each file is encapsulated within its own code block with appropriate filename comments.\n- Do not include explanations outside of code blocks to maintain clarity.\n\n**Example Task Execution:**\n\n1. HTML5 Component Development:\n\n```html\n\x3c!-- ./index.html --\x3e\n<link rel="stylesheet" href="./styles/display.css">\n<div id="calculator-display" class="component-display"></div>\n<script src="./modules/display.js" type="module"><\/script>\n```\n\n2. CSS3 Styling:\n\n```css\n/* ./styles/display.css */\n.component-display {\n  font-size: 2em;\n  color: #333;\n}\n```\n\n3. Vanilla JavaScript Functionality:\n\n```javascript\n// ./modules/display.js\nexport function updateDisplay(value) {\n  document.getElementById(\'calculator-display\').innerText = value;\n}\n\ndocument.addEventListener(\'DOMContentLoaded\', () => updateDisplay(\'0\'));\n```\n\n---\nThe user will provide the instructions to interpret, along with any out-of-character comments, which are details to align with the information space being explored and the content being generated.';